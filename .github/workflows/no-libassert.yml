name: No libassert

on:
  schedule:
    - cron: 0 1 * * * # Nightly at 01:00 UTC
  push:
    branches:
      - master
  pull_request:

jobs:
  linux_cmake:
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        config:
          - runner: ubuntu-current
            name: GCC Latest
            toolchain: "./resolve_symlinks/toolchains/gcc-toolchain.cmake"
          - runner: ubuntu-current
            name: Clang Latest
            toolchain: "./resolve_symlinks/toolchains/clang-toolchain.cmake"
          - runner: ubuntu-current
            name: Clang ASAN Latest
            toolchain: "./resolve_symlinks/toolchains/clang-asan-toolchain.cmake"
          - runner: ubuntu-current
            name: Clang TSAN Latest
            toolchain: "./resolve_symlinks/toolchains/clang-tsan-toolchain.cmake"
          - runner: ubuntu-current
            name: Clang UBSAN Latest
            toolchain: "./resolve_symlinks/toolchains/clang-ubsan-toolchain.cmake"
          - runner: ubuntu-old
            name: GCC Oldest
            toolchain: "./resolve_symlinks/toolchains/gcc-toolchain.cmake"
          - runner: ubuntu-old
            name: Clang Oldest
            toolchain: "./resolve_symlinks/toolchains/clang-toolchain.cmake"
    runs-on:
      - self-hosted
      - vm
      - ${{ matrix.config.runner }}
    name: ${{ matrix.config.name }} no libassert
    steps:
      # This is sometimes needed when running docker builds since these
      # sometimes produce files with root ownership
      - name: Ensure correct owner of repository
        run: sudo chown -R actions-runner:actions-runner .
      - name: Checkout source code
        uses: actions/checkout@v3
      - name: Waf Configure
        run: python3 waf configure --git_protocol=git@ --cmake_toolchain=${{ matrix.config.toolchain }} --cmake_verbose --no_libassert
      - name: Waf Build
        run: python3 waf build --run_tests

  macos_cmake:
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        config:
          - arch: ARM64
            os: big_sur
            name: Apple Big Sur (ARM)
            toolchain: "./resolve_symlinks/toolchains/clang-toolchain.cmake"
    runs-on:
      - self-hosted
      - macOS
      - ${{ matrix.config.os }}
      - ${{ matrix.config.arch }}
      - cmake
      - builder
    name: ${{ matrix.config.name }} no libassert
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Waf Configure
        run: python3 waf configure --git_protocol=git@ --cmake_toolchain=${{ matrix.config.toolchain }} --cmake_verbose --no_libassert
      - name: Waf Build
        run: python3 waf build --run_tests

  windows_cmake:
    timeout-minutes: 45
    runs-on: [self-hosted, windows, vm, windows-current]
    name: Windows no libassert
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Waf Configure
        run: python waf configure --git_protocol=git@ --cmake_verbose --no_libassert
      - name: Waf Build
        run: python waf build --run_tests

  workflow-keepalive:
    if: github.event_name == 'schedule'
    runs-on: [self-hosted, vm, ubuntu-current]
    permissions:
      actions: write
    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh
      - uses: liskin/gh-workflow-keepalive@v1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true
